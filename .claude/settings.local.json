{
  "permissions": {
    "allow": [
      "Bash(/home/eduardo/Desktop/Oferta/Proyectos/Dashboard_productivos/dashboard/scripts/fetch_and_aggregate.mjs << 'ENDOFFILE'\n#!/usr/bin/env node\n// scripts/fetch_and_aggregate.mjs\n// Lee Google Sheet privado vía Service Account, agrega por AÑO+MES y técnico,\n// y genera public/data.json SOLO con agregados \\(nunca filas crudas\\).\n\nimport { google } from 'googleapis';\nimport { readFileSync, writeFileSync, existsSync } from 'node:fs';\nimport { fileURLToPath } from 'node:url';\nimport { dirname, join } from 'node:path';\n\nconst __dirname = dirname\\(fileURLToPath\\(import.meta.url\\)\\);\nconst CONFIG = JSON.parse\\(readFileSync\\(join\\(__dirname, 'config.json'\\), 'utf-8'\\)\\);\nconst DATA_PATH = join\\(__dirname, '..', 'public', 'data.json'\\);\n\nconst META = CONFIG.metaMensual;\nconst TECNICO_KEYS = Object.keys\\(CONFIG.tecnicos\\);\n\n// ── Utilidades ────────────────────────────────────────────────────────────────\n\nconst MONTH_MAP = {\n  ENERO: '01', FEBRERO: '02', MARZO: '03', ABRIL: '04',\n  MAYO: '05',  JUNIO: '06',  JULIO: '07', AGOSTO: '08',\n  SEPTIEMBRE: '09', OCTUBRE: '10', NOVIEMBRE: '11', DICIEMBRE: '12',\n};\n\nfunction normalize\\(str\\) {\n  return String\\(str\\).trim\\(\\).toUpperCase\\(\\).replace\\(/\\\\s+/g, ' '\\);\n}\n\nfunction resolveTecnico\\(raw\\) {\n  const norm = normalize\\(raw\\);\n  for \\(const [key, aliases] of Object.entries\\(CONFIG.tecnicos\\)\\) {\n    if \\(aliases.some\\(a => normalize\\(a\\) === norm\\)\\) return key;\n  }\n  return null;\n}\n\nfunction mesTextoANumero\\(mesTexto\\) {\n  return MONTH_MAP[normalize\\(mesTexto\\)] ?? null;\n}\n\n// ── Google Sheets ─────────────────────────────────────────────────────────────\n\nasync function fetchFromSheets\\(\\) {\n  const saJson = process.env.GSHEET_SERVICE_ACCOUNT_JSON;\n  const sheetId = process.env.GSHEET_ID;\n  const range = process.env.GSHEET_RANGE;\n\n  if \\(!saJson || !sheetId || !range\\) return null;\n\n  const credentials = JSON.parse\\(saJson\\);\n  const auth = new google.auth.GoogleAuth\\({\n    credentials,\n    scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly'],\n  }\\);\n\n  const sheets = google.sheets\\({ version: 'v4', auth }\\);\n  const res = await sheets.spreadsheets.values.get\\({\n    spreadsheetId: sheetId,\n    range,\n  }\\);\n\n  return res.data.values;\n}\n\n// ── Procesamiento ─────────────────────────────────────────────────────────────\n\nfunction processRows\\(rows\\) {\n  if \\(!rows || rows.length < 2\\) {\n    throw new Error\\('La hoja no tiene filas de datos \\(se esperaban al menos headers + 1 fila\\).'\\);\n  }\n\n  const headers = rows[0].map\\(h => normalize\\(h\\)\\);\n\n  const colExpositor = normalize\\(CONFIG.sheet.colExpositor\\);\n  const colAno = normalize\\(CONFIG.sheet.colAno\\);\n  const colMes = normalize\\(CONFIG.sheet.colMes\\);\n\n  const iExp = headers.indexOf\\(colExpositor\\);\n  const iAno = headers.indexOf\\(colAno\\);\n  const iMes = headers.indexOf\\(colMes\\);\n\n  if \\(iExp === -1 || iAno === -1 || iMes === -1\\) {\n    throw new Error\\(\n      'Headers no coinciden con config.\\\\n' +\n      '  Esperados : \"' + colAno + '\", \"' + colMes + '\", \"' + colExpositor + '\"\\\\n' +\n      '  Detectados: ' + JSON.stringify\\(headers\\)\n    \\);\n  }\n\n  // Acumular conteo: monthly[\"YYYY-MM\"][\"TECNICO\"] = count\n  const monthly = {};\n\n  for \\(let i = 1; i < rows.length; i++\\) {\n    const row = rows[i];\n    const rawAno = row[iAno];\n    const rawMes = row[iMes];\n    const rawExp = row[iExp];\n\n    if \\(!rawAno || !rawMes || !rawExp\\) continue;\n\n    const ano = String\\(rawAno\\).trim\\(\\);\n    const mesNum = mesTextoANumero\\(rawMes\\);\n    if \\(!mesNum\\) continue;\n\n    const tecnico = resolveTecnico\\(rawExp\\);\n    if \\(!tecnico\\) continue;\n\n    const mk = ano + '-' + mesNum;\n    if \\(!monthly[mk]\\) {\n      monthly[mk] = Object.fromEntries\\(TECNICO_KEYS.map\\(t => [t, 0]\\)\\);\n    }\n    monthly[mk][tecnico]++;\n  }\n\n  if \\(Object.keys\\(monthly\\).length === 0\\) {\n    throw new Error\\('No se encontraron filas válidas con técnicos conocidos.'\\);\n  }\n\n  // Series ordenadas cronológicamente\n  const sortedMonths = Object.keys\\(monthly\\).sort\\(\\);\n  const series = sortedMonths.map\\(mk => {\n    const entry = { month: mk };\n    for \\(const t of TECNICO_KEYS\\) entry[t] = monthly[mk][t] ?? 0;\n    return entry;\n  }\\);\n\n  // Mes actual = último del dataset\n  const currentMk = sortedMonths[sortedMonths.length - 1];\n  const cur = monthly[currentMk];\n\n  const tecnicos = TECNICO_KEYS.map\\(t => {\n    const realizado = cur[t] ?? 0;\n    const balance = realizado - META;\n    const pct = Math.round\\(\\(realizado / META\\) * 100\\) / 100;\n    const cumple = realizado >= META;\n    return {\n      tecnico: t,\n      realizado,\n      meta: META,\n      balance,\n      pct,\n      estado: cumple ? 'PAGO OK' : 'OBSERVADO',\n      accion: cumple ? 'PROCESAR PAGO' : 'RETENER PAGO',\n    };\n  }\\);\n\n  const total = tecnicos.reduce\\(\\(s, t\\) => s + t.realizado, 0\\);\n\n  return {\n    generatedAt: new Date\\(\\).toISOString\\(\\),\n    metaMensual: META,\n    currentMonth: currentMk,\n    current: {\n      mk: currentMk,\n      total,\n      cumplidas: tecnicos.filter\\(t => t.realizado >= META\\).length,\n      noCumplidas: tecnicos.filter\\(t => t.realizado < META\\).length,\n      tecnicos,\n    },\n    series,\n  };\n}\n\n// ── Fallback \\(sin env vars\\) ───────────────────────────────────────────────────\n\nfunction handleFallback\\(\\) {\n  if \\(existsSync\\(DATA_PATH\\)\\) {\n    try {\n      const existing = JSON.parse\\(readFileSync\\(DATA_PATH, 'utf-8'\\)\\);\n      if \\(existing.generatedAt && existing.current\\) {\n        console.log\\('Sin variables de entorno. Usando public/data.json existente \\(fallback\\).'\\);\n        return;\n      }\n    } catch { /* JSON roto, crear semilla */ }\n  }\n\n  console.log\\('Sin variables de entorno ni data.json valido. Creando semilla...'\\);\n  const now = new Date\\(\\);\n  const mk = now.getFullYear\\(\\) + '-' + String\\(now.getMonth\\(\\) + 1\\).padStart\\(2, '0'\\);\n\n  const seed = {\n    generatedAt: now.toISOString\\(\\),\n    metaMensual: META,\n    currentMonth: mk,\n    current: {\n      mk,\n      total: 0,\n      cumplidas: 0,\n      noCumplidas: TECNICO_KEYS.length,\n      tecnicos: TECNICO_KEYS.map\\(t => \\({\n        tecnico: t, realizado: 0, meta: META, balance: -META,\n        pct: 0, estado: 'OBSERVADO', accion: 'RETENER PAGO',\n      }\\)\\),\n    },\n    series: [],\n  };\n\n  writeFileSync\\(DATA_PATH, JSON.stringify\\(seed, null, 2\\)\\);\n  console.log\\('Semilla public/data.json creada.'\\);\n}\n\n// ── Main ──────────────────────────────────────────────────────────────────────\n\nasync function main\\(\\) {\n  console.log\\('Obteniendo datos de Google Sheets...'\\);\n\n  const rows = await fetchFromSheets\\(\\);\n\n  if \\(rows === null\\) {\n    handleFallback\\(\\);\n    return;\n  }\n\n  console.log\\('Recibidas ' + rows.length + ' filas. Procesando...'\\);\n  const data = processRows\\(rows\\);\n  writeFileSync\\(DATA_PATH, JSON.stringify\\(data, null, 2\\)\\);\n  console.log\\('public/data.json generado \\(' + data.series.length + ' meses, actual: ' + data.currentMonth + '\\).'\\);\n}\n\nmain\\(\\).catch\\(err => {\n  console.error\\('Error:', err.message\\);\n  process.exit\\(1\\);\n}\\);\nENDOFFILE)",
      "Bash(/home/eduardo/Desktop/Oferta/Proyectos/Dashboard_productivos/dashboard/public/data.json << 'ENDOFFILE'\n{\n  \"generatedAt\": \"2025-01-01T00:00:00.000Z\",\n  \"metaMensual\": 120,\n  \"currentMonth\": \"2025-01\",\n  \"current\": {\n    \"mk\": \"2025-01\",\n    \"total\": 0,\n    \"cumplidas\": 0,\n    \"noCumplidas\": 3,\n    \"tecnicos\": [\n      { \"tecnico\": \"MARIA\", \"realizado\": 0, \"meta\": 120, \"balance\": -120, \"pct\": 0, \"estado\": \"OBSERVADO\", \"accion\": \"RETENER PAGO\" },\n      { \"tecnico\": \"ANDER\", \"realizado\": 0, \"meta\": 120, \"balance\": -120, \"pct\": 0, \"estado\": \"OBSERVADO\", \"accion\": \"RETENER PAGO\" },\n      { \"tecnico\": \"CRISTHIAN\", \"realizado\": 0, \"meta\": 120, \"balance\": -120, \"pct\": 0, \"estado\": \"OBSERVADO\", \"accion\": \"RETENER PAGO\" }\n    ]\n  },\n  \"series\": []\n}\nENDOFFILE)",
      "Bash(/home/eduardo/Desktop/Oferta/Proyectos/Dashboard_productivos/dashboard/src/lib/data.js << 'ENDOFFILE'\nexport async function loadDashboardData\\(\\) {\n  const res = await fetch\\('./data.json'\\);\n  if \\(!res.ok\\) throw new Error\\(`Error cargando datos: ${res.status}`\\);\n  return res.json\\(\\);\n}\nENDOFFILE)",
      "Bash(/home/eduardo/Desktop/Oferta/Proyectos/Dashboard_productivos/dashboard/src/styles/theme.css << 'ENDOFFILE'\n:root {\n  --bg: #f0f2f5;\n  --card-bg: #ffffff;\n  --primary: #1a73e8;\n  --success: #34a853;\n  --warning: #ea4335;\n  --orange: #ff7300;\n  --text: #202124;\n  --text-secondary: #5f6368;\n  --border: #dadce0;\n  --radius: 8px;\n  --shadow: 0 1px 3px rgba\\(0, 0, 0, 0.12\\);\n}\n\n*,\n*::before,\n*::after {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: 'Segoe UI', Roboto, -apple-system, sans-serif;\n  background: var\\(--bg\\);\n  color: var\\(--text\\);\n  line-height: 1.5;\n  -webkit-font-smoothing: antialiased;\n}\nENDOFFILE)",
      "Bash(/home/eduardo/Desktop/Oferta/Proyectos/Dashboard_productivos/dashboard/src/styles/dashboard.css << 'ENDOFFILE'\n/* ── Layout ─────────────────────────────────────────────────────────── */\n.dashboard {\n  max-width: 1200px;\n  margin: 0 auto;\n  padding: 24px 16px;\n}\n\n.dashboard-header {\n  margin-bottom: 24px;\n}\n\n.dashboard-header h1 {\n  font-size: 24px;\n  font-weight: 700;\n}\n\n.dashboard-header .subtitle {\n  color: var\\(--text-secondary\\);\n  font-size: 13px;\n  margin-top: 4px;\n}\n\n/* ── KPI Cards ──────────────────────────────────────────────────────── */\n.kpi-grid {\n  display: grid;\n  grid-template-columns: repeat\\(auto-fit, minmax\\(200px, 1fr\\)\\);\n  gap: 16px;\n  margin-bottom: 24px;\n}\n\n.kpi-card {\n  background: var\\(--card-bg\\);\n  border-radius: var\\(--radius\\);\n  box-shadow: var\\(--shadow\\);\n  padding: 20px;\n}\n\n.kpi-card .label {\n  font-size: 12px;\n  color: var\\(--text-secondary\\);\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  font-weight: 600;\n}\n\n.kpi-card .value {\n  font-size: 32px;\n  font-weight: 700;\n  margin-top: 4px;\n}\n\n.kpi-card .value.primary  { color: var\\(--primary\\); }\n.kpi-card .value.success  { color: var\\(--success\\); }\n.kpi-card .value.warning  { color: var\\(--warning\\); }\n\n/* ── Chart ──────────────────────────────────────────────────────────── */\n.chart-container {\n  background: var\\(--card-bg\\);\n  border-radius: var\\(--radius\\);\n  box-shadow: var\\(--shadow\\);\n  padding: 20px;\n  margin-bottom: 24px;\n}\n\n.chart-container h2 {\n  font-size: 16px;\n  font-weight: 600;\n  margin-bottom: 16px;\n}\n\n/* ── Payment Status ─────────────────────────────────────────────────── */\n.payment-grid {\n  display: grid;\n  grid-template-columns: repeat\\(auto-fit, minmax\\(300px, 1fr\\)\\);\n  gap: 16px;\n  margin-bottom: 24px;\n}\n\n.payment-card {\n  background: var\\(--card-bg\\);\n  border-radius: var\\(--radius\\);\n  box-shadow: var\\(--shadow\\);\n  padding: 20px;\n  border-left: 4px solid var\\(--border\\);\n}\n\n.payment-card.ok        { border-left-color: var\\(--success\\); }\n.payment-card.observado { border-left-color: var\\(--warning\\); }\n\n.payment-card .tech-name {\n  font-weight: 700;\n  font-size: 16px;\n  margin-bottom: 8px;\n}\n\n.payment-card .stats {\n  display: flex;\n  gap: 16px;\n  margin-bottom: 12px;\n  font-size: 14px;\n  color: var\\(--text-secondary\\);\n}\n\n.progress-bar {\n  width: 100%;\n  height: 8px;\n  background: #e8eaed;\n  border-radius: 4px;\n  overflow: hidden;\n}\n\n.progress-bar .fill {\n  height: 100%;\n  border-radius: 4px;\n  transition: width 0.4s ease;\n}\n\n.fill.success { background: var\\(--success\\); }\n.fill.warning { background: var\\(--warning\\); }\n\n.badge {\n  display: inline-block;\n  padding: 4px 12px;\n  border-radius: 12px;\n  font-size: 12px;\n  font-weight: 600;\n}\n\n.badge.pago-ok    { background: #e6f4ea; color: var\\(--success\\); }\n.badge.observado  { background: #fce8e6; color: var\\(--warning\\); }\n\n.payment-card .footer {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-top: 12px;\n}\n\n.payment-card .accion {\n  font-size: 13px;\n  font-weight: 500;\n}\n\n.payment-card .pct-label {\n  font-size: 13px;\n  color: var\\(--text-secondary\\);\n}\n\n/* ── Table ──────────────────────────────────────────────────────────── */\n.table-container {\n  background: var\\(--card-bg\\);\n  border-radius: var\\(--radius\\);\n  box-shadow: var\\(--shadow\\);\n  overflow: hidden;\n}\n\n.table-container h2 {\n  font-size: 16px;\n  font-weight: 600;\n  padding: 20px 20px 12px;\n}\n\n.table-container table {\n  width: 100%;\n  border-collapse: collapse;\n}\n\n.table-container th {\n  background: #f8f9fa;\n  font-size: 11px;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  color: var\\(--text-secondary\\);\n  padding: 10px 16px;\n  text-align: left;\n  border-bottom: 1px solid var\\(--border\\);\n}\n\n.table-container td {\n  padding: 12px 16px;\n  font-size: 14px;\n  border-bottom: 1px solid var\\(--border\\);\n}\n\n.table-container tr:last-child td {\n  border-bottom: none;\n}\n\n/* ── Loading / Error ────────────────────────────────────────────────── */\n.state-message {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  height: 60vh;\n  font-size: 18px;\n}\n\n.state-message.error {\n  color: var\\(--warning\\);\n}\nENDOFFILE)",
      "Bash(/home/eduardo/Desktop/Oferta/Proyectos/Dashboard_productivos/dashboard/src/components/KPICards.jsx << 'ENDOFFILE'\nexport default function KPICards\\({ current, metaMensual }\\) {\n  return \\(\n    <div className=\"kpi-grid\">\n      <div className=\"kpi-card\">\n        <div className=\"label\">Total Capacitados</div>\n        <div className=\"value primary\">{current.total}</div>\n      </div>\n      <div className=\"kpi-card\">\n        <div className=\"label\">Meta Mensual</div>\n        <div className=\"value\">{metaMensual}</div>\n      </div>\n      <div className=\"kpi-card\">\n        <div className=\"label\">Metas Cumplidas</div>\n        <div className=\"value success\">{current.cumplidas}</div>\n      </div>\n      <div className=\"kpi-card\">\n        <div className=\"label\">Metas No Cumplidas</div>\n        <div className=\"value warning\">{current.noCumplidas}</div>\n      </div>\n    </div>\n  \\);\n}\nENDOFFILE)",
      "Bash(/home/eduardo/Desktop/Oferta/Proyectos/Dashboard_productivos/dashboard/src/components/PerformanceChart.jsx << 'ENDOFFILE'\nimport {\n  BarChart, Bar, XAxis, YAxis, CartesianGrid,\n  Tooltip, Legend, ReferenceLine, ResponsiveContainer,\n} from 'recharts';\nimport { formatMonth } from '../lib/format.js';\n\nconst COLORS = {\n  MARIA: '#1a73e8',\n  ANDER: '#34a853',\n  CRISTHIAN: '#ea4335',\n};\n\nexport default function PerformanceChart\\({ series, metaMensual }\\) {\n  if \\(!series || series.length === 0\\) {\n    return \\(\n      <div className=\"chart-container\">\n        <h2>Rendimiento por Tecnico</h2>\n        <p style={{ color: 'var\\(--text-secondary\\)', padding: 20 }}>\n          Sin datos historicos disponibles.\n        </p>\n      </div>\n    \\);\n  }\n\n  const chartData = series.map\\(s => \\({\n    ...s,\n    name: formatMonth\\(s.month\\),\n  }\\)\\);\n\n  return \\(\n    <div className=\"chart-container\">\n      <h2>Rendimiento por Tecnico</h2>\n      <ResponsiveContainer width=\"100%\" height={350}>\n        <BarChart data={chartData}>\n          <CartesianGrid strokeDasharray=\"3 3\" />\n          <XAxis dataKey=\"name\" fontSize={12} />\n          <YAxis />\n          <Tooltip />\n          <Legend />\n          <ReferenceLine\n            y={metaMensual}\n            stroke=\"#ff7300\"\n            strokeDasharray=\"5 5\"\n            label={{ value: 'Meta 120', position: 'right', fontSize: 12 }}\n          />\n          {Object.entries\\(COLORS\\).map\\(\\([key, color]\\) => \\(\n            <Bar key={key} dataKey={key} fill={color} radius={[4, 4, 0, 0]} />\n          \\)\\)}\n        </BarChart>\n      </ResponsiveContainer>\n    </div>\n  \\);\n}\nENDOFFILE)",
      "Bash(/home/eduardo/Desktop/Oferta/Proyectos/Dashboard_productivos/dashboard/src/main.jsx << 'ENDOFFILE'\nimport React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport App from './App.jsx';\nimport './styles/theme.css';\nimport './styles/dashboard.css';\n\nReactDOM.createRoot\\(document.getElementById\\('root'\\)\\).render\\(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>\n\\);\nENDOFFILE)",
      "Bash(npm install:*)",
      "Bash(npm run fetch:data:*)",
      "Bash(npm run validate:data:*)",
      "Bash(npm run build:*)"
    ]
  }
}
